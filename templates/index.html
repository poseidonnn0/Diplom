<!DOCTYPE html>
<html>
<head>
    <title>People Counter Analytics</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 2rem;
            background-color: #f5f6fa;
        }

        .dashboard {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .stats-title {
            font-size: 1.5rem;
            color: #2d3436;
        }

        .last-update {
            color: #636e72;
            font-size: 0.9rem;
        }

        .zones-container {
            display: grid;
            gap: 1.2rem;
        }

        .zone-card {
            padding: 1.2rem;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid;
        }

        .zone-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }

        .zone-name {
            font-weight: 600;
            color: #2d3436;
        }

        .zone-count {
            font-weight: 700;
            color: #0984e3;
        }

        .progress-container {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            transition: width 0.3s ease;
        }

        .zone-meta {
            margin-top: 1rem;
            display: flex;
            gap: 1.5rem;
            font-size: 0.85rem;
            color: #636e72;
        }

        .form-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2d3436;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #dcdde1;
            border-radius: 6px;
            font-size: 1rem;
        }

        button {
            background: #0984e3;
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
            font-size: 1rem;
        }

        button:hover {
            background: #0873c4;
        }

        .progress-bar.low-load {
            background: #2ecc71;
        }

        .progress-bar.medium-load {
            background: #f1c40f;
        }

        .progress-bar.high-load {
            background: #e67e22;
        }

        .progress-bar.critical-load {
            background: #e74c3c;
        }

        .days-filter {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            justify-content: space-between;
        }

        .day-btn {
            padding: 0.6rem 1rem;
            background: #0984e3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1 1 auto;
            text-align: center;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .day-btn:hover {
            background: #0873c4;
        }

        .day-btn.active {
            background: #065a9c;
        }

        #combinedChart {
            width: 100%!important;
            height: 100%!important;
        }

        @media (max-width: 1200px) {
            .day-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.85rem;
            }
        }

        @media (max-width: 992px) {
            body {
                margin: 1rem;
            }

            .day-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .day-btn {
                font-size: 0.75rem;
                padding: 0.3rem 0.5rem;
            }
        }

        #toggleRounding {
            background: #27ae60;
            padding: 0.6rem 1.2rem;
            margin-left: auto;
        }
        #toggleRounding:hover {
            background: #219a52;
        }
    </style>
</head>
<body>
    <h1>üèôÔ∏è People Flow Analytics</h1>

    <div class="dashboard">
        <div class="stats-header">
            <div>
                <h2 class="stats-title">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h2>
                <div class="last-update">
                    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: {{ last_update.strftime('%H:%M:%S') if last_update else 'N/A' }}
                </div>
            </div>
            <div class="total-count">
                <div style="font-size: 0.9rem; color: #636e72;">–í—Å–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ª—é–¥–µ–π</div>
                <div style="font-size: 1.8rem; font-weight: 700;">{{ total_count }}</div>
            </div>
        </div>

        <div class="zones-container">
            {% for zone in zones %}
            <div class="zone-card" style="border-color: {{ zone.color }}">
                <div class="zone-header">
                    <div class="zone-name">{{ zone.name }}</div>
                    <div class="zone-count">{{ zone.count }} / {{ zone.max_capacity }}</div>
                </div>

                {% set percentage = (zone.count / zone.max_capacity * 100)|round(1) %}
                <div class="progress-container">
                    <div class="progress-bar
                        {% if percentage >= 90 %}critical-load
                        {% elif percentage >= 75 %}high-load
                        {% elif percentage >= 50 %}medium-load
                        {% else %}low-load
                        {% endif %}"
                        style="width: {{ percentage }}%">
                    </div>
                </div>

                <div class="zone-meta">
                    <div>
                        üìä
                        {% if percentage < 50 %}
                            –°–ª–∞–±–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
                        {% elif percentage < 75 %}
                            –°—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å
                        {% elif percentage < 90 %}
                            –í—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
                        {% else %}
                            –ü–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å
                        {% endif %}
                        ({{ percentage }}%)
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="dashboard">
        <h3>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–æ–Ω –ø–æ —á–∞—Å–∞–º</h3>
        <div style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center">
            <div class="days-filter">
                <button class="day-btn active" data-day="0">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫</button>
                <button class="day-btn" data-day="1">–í—Ç–æ—Ä–Ω–∏–∫</button>
                <button class="day-btn" data-day="2">–°—Ä–µ–¥–∞</button>
                <button class="day-btn" data-day="3">–ß–µ—Ç–≤–µ—Ä–≥</button>
                <button class="day-btn" data-day="4">–ü—è—Ç–Ω–∏—Ü–∞</button>
                <button class="day-btn" data-day="5">–°—É–±–±–æ—Ç–∞</button>
                <button class="day-btn" data-day="6">–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ</button>
                <button id="toggleRounding" class="day-btn">
                –û–∫—Ä—É–≥–ª—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è: ‚ùå
            </button>
            </div>
        </div>
        <div style="height: 70vh; width: 100%; border: 1px solid #ccc">
            <canvas id="combinedChart"></canvas>
        </div>
    </div>

    <div class="form-container">
        <h3 style="margin-top: 0; margin-bottom: 1.5rem;">üì• Export Historical Data</h3>
        <form id="downloadForm">
            <div class="form-group">
                <label>Start datetime</label>
                <input type="datetime-local" name="start" id="start" required>
            </div>

            <div class="form-group">
                <label>End datetime</label>
                <input type="datetime-local" name="end" id="end" required>
            </div>

            <div class="form-group">
                <label>File format</label>
                <select name="format">
                    <option value="xlsx">Excel (.xlsx)</option>
                    <option value="csv">CSV (.csv)</option>
                </select>
            </div>

            <button type="submit">Download Report</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let chartInstance = null;
        let allZonesData = {};
        let roundValues = false;
        const zoneColors = {
            'Main Entrance': '#2ecc71',
            'Food Court': '#e67e22',
            'VIP Lounge': '#9b59b6'
        };

        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');

                // 2. –ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
                const response = await fetch('/hourly_data');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);

                // 3. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö
                allZonesData = {};
                Object.entries(data.zones).forEach(([zoneName, days]) => {
                    allZonesData[zoneName] = Array.from({ length: 7 }, (_, dayIndex) => {
                        return Array.from({ length: 24 }, (_, hour) => {
                            return days[dayIndex]?.[hour] || 0;
                        });
                    });
                });

                console.log('–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', allZonesData);

                // 4. –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞
                updateChart(0);

                // 5. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏
                document.querySelectorAll('.day-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                        document.querySelectorAll('.day-btn').forEach(b => {
                            b.classList.remove('active');
                        });

                        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–Ω–æ–ø–∫–µ
                        this.classList.add('active');

                        // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
                        const selectedDay = parseInt(this.dataset.day);
                        console.log('–í—ã–±—Ä–∞–Ω –¥–µ–Ω—å:', selectedDay);
                        updateChart(selectedDay);
                    });
                });

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                document.getElementById('combinedChart').closest('div').innerHTML =
                    `<div style="color: red; padding: 20px">${error.message}</div>`;
            }
        });

        // 6. –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
        function updateChart(selectedDay) {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ –¥–ª—è –¥–Ω—è', selectedDay);

            // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≥—Ä–∞—Ñ–∏–∫
            if (chartInstance) {
                chartInstance.destroy();
            }

            const ctx = document.getElementById('combinedChart').getContext('2d');

            // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const labels = Array.from({ length: 24 }, (_, hour) => {
                return `${hour.toString().padStart(2, '0')}:00`;
            });

            const datasets = Object.entries(allZonesData).map(([zoneName, daysData]) => {
                const dayData = daysData[selectedDay] || [];

                return {
                    label: zoneName,
                    data: dayData.map(value => {
                        return roundValues ? Math.round(value) : Number(value.toFixed(1));
                    }),
                    borderColor: zoneColors[zoneName],
                    tension: 0.3,
                    fill: false
                };
            });

            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ–∏–∫
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '–í—Ä–µ–º—è —Å—É—Ç–æ–∫',
                                color: '#666',
                                font: { weight: 'bold' }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: `–°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π${roundValues ? '' : ' (—Ç–æ—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)'}`,
                                color: '#666',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return roundValues ? value : value.toFixed(1);
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return `${context.dataset.label}: ${
                                        roundValues ? Math.round(value) : value.toFixed(1)
                                    }`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        // 7. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è
        document.getElementById('toggleRounding').addEventListener('click', function() {
            console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è');
            roundValues = !roundValues;
            this.textContent = `–û–∫—Ä—É–≥–ª—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è: ${roundValues ? '‚úÖ' : '‚ùå'}`;

            const activeDay = document.querySelector('.day-btn.active').dataset.day;
            console.log('–ê–∫—Ç–∏–≤–Ω—ã–π –¥–µ–Ω—å:', activeDay);
            updateChart(parseInt(activeDay));
        });

        // 8. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —ç–∫—Å–ø–æ—Ä—Ç–∞
        document.getElementById('downloadForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã —ç–∫—Å–ø–æ—Ä—Ç–∞');

            try {
                const params = new URLSearchParams({
                    start: document.getElementById('start').value,
                    end: document.getElementById('end').value,
                    format: document.querySelector('[name="format"]').value
                });

                const response = await fetch(`/download?${params}`);
                if (!response.ok) throw new Error(await response.text());

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `people_data_${new Date().toISOString()}.${params.get('format')}`;
                a.click();
                window.URL.revokeObjectURL(url);

            } catch (error) {
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        });
    </script>
</body>
</html>